<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ankh-Morpork Scramble – Match View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1f160c;
            --bg-highlight: #2a1d11;
            --panel: #24170c;
            --panel-border: rgba(187, 142, 76, 0.45);
            --panel-shadow: rgba(8, 4, 0, 0.6);
            --accent-blue: #3f7cac;
            --accent-orange: #c46d28;
            --accent-gold: #d9b45b;
            --accent-gold-soft: rgba(217, 180, 91, 0.65);
            --grid: rgba(108, 78, 43, 0.45);
            --grid-alt: rgba(66, 46, 26, 0.55);
            --text: #f2e3c6;
            --muted: rgba(242, 227, 198, 0.7);
            --paper: #362312;
            --paper-highlight: rgba(242, 227, 198, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Spectral", Georgia, "Times New Roman", serif;
            background: radial-gradient(circle at 22% 16%, rgba(217, 180, 91, 0.12), transparent 55%),
                        radial-gradient(circle at 78% 12%, rgba(106, 76, 38, 0.18), transparent 50%),
                        radial-gradient(circle at 50% 80%, rgba(115, 76, 38, 0.15), transparent 55%),
                        var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: clamp(1.8rem, 3vw, 3rem) clamp(1.2rem, 4vw, 4rem) clamp(1.2rem, 3vw, 2.2rem);
            border-bottom: 1px solid rgba(217, 180, 91, 0.25);
            background: linear-gradient(135deg, rgba(36, 23, 12, 0.85), rgba(15, 9, 4, 0.75));
            box-shadow: inset 0 -1px 0 rgba(217, 180, 91, 0.15);
        }

        header h1 {
            margin: 0 0 0.5rem;
            font-family: "Cinzel", "Times New Roman", serif;
            font-size: clamp(2.2rem, 3.4vw, 3.1rem);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent-gold);
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        header .score-line {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: clamp(1rem, 5vw, 3rem);
            flex-wrap: wrap;
            border: 1px solid rgba(217, 180, 91, 0.35);
            border-radius: 18px;
            padding: 0.85rem 1.25rem;
            background: radial-gradient(circle at 50% 20%, rgba(217, 180, 91, 0.18), rgba(36, 23, 12, 0.85));
            box-shadow: 0 10px 24px rgba(10, 4, 0, 0.6);
        }

        header .score-line span {
            font-family: "Cinzel", "Times New Roman", serif;
            font-size: clamp(1.5rem, 3.2vw, 2.5rem);
            font-weight: 600;
            letter-spacing: 0.08em;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        header .score-line .score-team {
            color: var(--accent-gold);
            text-transform: uppercase;
        }

        header .score-line .score-team--home {
            color: rgba(198, 212, 223, 0.9);
        }

        header .score-line .score-team--away {
            color: rgba(247, 213, 180, 0.92);
        }

        header .score-line .score-value {
            color: var(--accent-gold);
            position: relative;
        }

        header .score-line .score-value small {
            display: block;
            font-size: 0.65em;
            letter-spacing: 0.2em;
            color: rgba(242, 227, 198, 0.7);
        }

        header .score-line .score-divider {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.28em;
            color: rgba(217, 180, 91, 0.75);
        }

        header .score-line small {
            font-size: clamp(0.95rem, 2vw, 1.2rem);
            color: var(--muted);
            font-family: "Spectral", Georgia, serif;
            letter-spacing: 0.04em;
        }

        header .meta {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }

        header .meta span {
            background: rgba(73, 50, 24, 0.65);
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            font-size: 0.85rem;
            letter-spacing: 0.04em;
            border: 1px solid rgba(217, 180, 91, 0.22);
            text-transform: uppercase;
            font-family: "Cinzel", "Times New Roman", serif;
            color: rgba(242, 227, 198, 0.8);
        }

        header .meta span[data-role="ball"] {
            background: rgba(217, 180, 91, 0.2);
            color: var(--accent-gold);
            border-color: rgba(217, 180, 91, 0.35);
        }

        main {
            flex: 1;
            padding: clamp(1.5rem, 3vw, 3rem);
            display: grid;
            grid-template-columns: minmax(220px, 1fr) minmax(560px, 2fr) minmax(220px, 1fr);
            gap: clamp(1rem, 2.5vw, 2rem);
        }

        @media (max-width: 1100px) {
            main {
                grid-template-columns: 1fr;
            }

            .thoughts {
                order: 3;
            }
        }

        .panel {
            background: linear-gradient(160deg, rgba(54, 35, 18, 0.85), rgba(30, 19, 10, 0.95));
            border: 1px solid var(--panel-border);
            border-radius: 18px;
            padding: clamp(1.25rem, 2.5vw, 2rem);
            box-shadow: 0 24px 60px var(--panel-shadow);
            position: relative;
            backdrop-filter: blur(2px);
        }

        .panel h2 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--accent-gold);
            font-family: "Cinzel", "Times New Roman", serif;
            border-bottom: 1px solid rgba(217, 180, 91, 0.2);
            padding-bottom: 0.35rem;
        }

        .thoughts ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .thoughts li {
            background: rgba(46, 30, 16, 0.82);
            border: 1px solid rgba(217, 180, 91, 0.18);
            border-radius: 14px;
            padding: 0.75rem 0.9rem;
            font-size: 0.95rem;
            line-height: 1.45;
            box-shadow: inset 0 1px 0 rgba(217, 180, 91, 0.1);
        }

        .thoughts .speaker {
            display: block;
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: var(--accent-gold);
            letter-spacing: 0.05em;
            font-family: "Cinzel", "Times New Roman", serif;
            text-transform: uppercase;
        }

        .pitch-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pitch-wrapper {
            background: radial-gradient(circle at 30% 18%, rgba(217, 180, 91, 0.12), transparent 55%),
                        radial-gradient(circle at 70% 72%, rgba(115, 76, 38, 0.18), transparent 60%),
                        rgba(30, 19, 10, 0.9);
            border-radius: 16px;
            padding: clamp(1rem, 2vw, 1.75rem);
            border: 1px solid rgba(217, 180, 91, 0.25);
            position: relative;
            box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.35);
        }

        .pitch-canvas {
            width: 100%;
            height: auto;
            display: block;
            aspect-ratio: 26 / 15;
            filter: saturate(85%);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--muted);
            letter-spacing: 0.02em;
            font-style: italic;
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend .swatch {
            width: 0.9rem;
            height: 0.9rem;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        thead th {
            text-align: left;
            font-weight: 600;
            padding: 0.5rem 0.25rem;
            color: var(--accent-gold);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            font-size: 0.78rem;
            border-bottom: 1px solid rgba(217, 180, 91, 0.28);
            font-family: "Cinzel", "Times New Roman", serif;
        }

        tbody tr td {
            padding: 0.5rem 0.25rem;
            border-top: 1px solid rgba(217, 180, 91, 0.16);
            color: rgba(242, 227, 198, 0.92);
        }

        tbody tr:first-child td {
            border-top: none;
        }

        .team-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
            background: rgba(73, 50, 24, 0.5);
            border: 1px solid rgba(217, 180, 91, 0.28);
        }

        .team-pill[data-team="team1"] {
            background: rgba(63, 124, 172, 0.28);
            color: #c6d4df;
            border-color: rgba(63, 124, 172, 0.35);
        }

        .team-pill[data-team="team2"] {
            background: rgba(196, 109, 40, 0.28);
            color: #f7d5b4;
            border-color: rgba(196, 109, 40, 0.35);
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            padding: 0.75rem 0.9rem;
            background: rgba(36, 23, 12, 0.96);
            border: 1px solid rgba(217, 180, 91, 0.45);
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
            max-width: 240px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
            opacity: 0;
            transform: translate(-50%, -110%);
            transition: opacity 0.12s ease;
            z-index: 10;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip .name {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
            font-family: "Cinzel", "Times New Roman", serif;
        }

        .tooltip .stat-line {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.35rem;
            font-size: 0.78rem;
            color: var(--muted);
            letter-spacing: 0.05em;
        }

        .game-log {
            background: rgba(30, 19, 10, 0.88);
            border: 1px solid rgba(217, 180, 91, 0.25);
            border-radius: 14px;
            padding: 1rem 1.25rem;
            box-shadow: inset 0 1px 0 rgba(217, 180, 91, 0.12);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .game-log h3 {
            margin: 0 0 0.5rem;
            font-family: "Cinzel", "Times New Roman", serif;
            font-size: 1rem;
            letter-spacing: 0.08em;
            color: var(--accent-gold);
            text-transform: uppercase;
        }

        .game-log .log-entries {
            flex: 1;
            font-size: 0.88rem;
            color: var(--muted);
            line-height: 1.6;
            overflow-y: auto;
            max-height: 400px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        .game-log .log-entries h1,
        .game-log .log-entries h2,
        .game-log .log-entries h3 {
            color: var(--accent-gold);
            font-family: "Cinzel", "Times New Roman", serif;
            margin: 0.8rem 0 0.4rem;
            line-height: 1.3;
        }

        .game-log .log-entries h1 {
            font-size: 1.3rem;
            border-bottom: 2px solid rgba(217, 180, 91, 0.3);
            padding-bottom: 0.3rem;
        }

        .game-log .log-entries h2 {
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(217, 180, 91, 0.2);
            padding-bottom: 0.25rem;
        }

        .game-log .log-entries h3 {
            font-size: 1rem;
        }

        .game-log .log-entries strong {
            color: var(--text);
            font-weight: 600;
        }

        .game-log .log-entries hr {
            border: none;
            border-top: 1px solid rgba(217, 180, 91, 0.25);
            margin: 0.8rem 0;
        }

        .game-log .log-entries ul {
            margin: 0.3rem 0;
            padding-left: 1.2rem;
        }

        .game-log .log-entries li {
            margin: 0.2rem 0;
        }

        .game-log .log-entries table {
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }

        .game-log .log-entries th {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .roster-panel {
            background: rgba(30, 19, 10, 0.86);
            border-radius: 14px;
            border: 1px solid rgba(217, 180, 91, 0.22);
            padding: 1rem 1.25rem;
            box-shadow: inset 0 1px 0 rgba(217, 180, 91, 0.1);
        }

        .roster-panel h2 {
            margin-bottom: 0.75rem;
            font-size: 1.05rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--accent-gold);
            font-family: "Cinzel", "Times New Roman", serif;
            border-bottom: 1px solid rgba(217, 180, 91, 0.2);
            padding-bottom: 0.35rem;
        }

        footer {
            padding: 1.5rem clamp(1rem, 3vw, 3rem);
            text-align: center;
            color: rgba(217, 180, 91, 0.6);
            font-size: 0.85rem;
            letter-spacing: 0.04em;
            font-style: italic;
        }

        .scoreboard-overlay {
            position: fixed;
            inset: 0;
            background: rgba(8, 4, 0, 0.78);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1rem, 4vw, 4rem);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .scoreboard-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .scoreboard-panel {
            width: min(960px, 100%);
            background: linear-gradient(170deg, rgba(36, 23, 12, 0.95), rgba(18, 11, 6, 0.92));
            border: 1px solid rgba(217, 180, 91, 0.35);
            border-radius: 22px;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.65);
            padding: clamp(1.5rem, 3vw, 2.75rem);
            color: var(--text);
            display: flex;
            flex-direction: column;
            gap: clamp(1.2rem, 2.5vw, 2rem);
        }

        .scoreboard-header h2 {
            margin: 0;
            font-family: "Cinzel", "Times New Roman", serif;
            font-size: clamp(2rem, 3.5vw, 3rem);
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--accent-gold);
        }

        .scoreboard-header p {
            margin: 0.35rem 0 0;
            color: rgba(242, 227, 198, 0.75);
            font-size: clamp(0.95rem, 1.8vw, 1.1rem);
            letter-spacing: 0.04em;
        }

        .scoreboard-scoreline {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: clamp(1rem, 2.5vw, 2.5rem);
            align-items: center;
            background: rgba(30, 19, 10, 0.72);
            border-radius: 18px;
            border: 1px solid rgba(217, 180, 91, 0.25);
            padding: clamp(1.25rem, 2vw, 1.75rem);
            text-align: center;
        }

        .scoreboard-team-name {
            display: block;
            font-family: "Cinzel", "Times New Roman", serif;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent-gold);
            font-size: clamp(1.2rem, 2vw, 1.5rem);
        }

        .scoreboard-team-score {
            display: block;
            font-size: clamp(2.5rem, 4vw, 3.2rem);
            font-weight: 600;
            color: rgba(242, 227, 198, 0.95);
        }

        .scoreboard-score-divider {
            font-size: clamp(1rem, 2vw, 1.4rem);
            letter-spacing: 0.3em;
            color: rgba(217, 180, 91, 0.7);
            text-transform: uppercase;
        }

        .scoreboard-key-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: clamp(0.75rem, 1.8vw, 1.5rem);
        }

        .scoreboard-stat-card {
            background: rgba(30, 19, 10, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(217, 180, 91, 0.28);
            padding: 1rem 1.2rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .scoreboard-stat-card h4 {
            margin: 0;
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(217, 180, 91, 0.85);
        }

        .scoreboard-stat-values {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .scoreboard-stat-values span {
            font-family: "Cinzel", "Times New Roman", serif;
        }

        .scoreboard-stat-meta {
            font-size: 0.8rem;
            color: rgba(242, 227, 198, 0.65);
            letter-spacing: 0.03em;
        }

        .scoreboard-highlights h3 {
            margin: 0 0 0.6rem;
            font-family: "Cinzel", "Times New Roman", serif;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent-gold);
            font-size: 1rem;
        }

        .scoreboard-highlights ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.8rem;
        }

        .scoreboard-highlights li {
            background: rgba(36, 23, 12, 0.85);
            border-radius: 14px;
            border: 1px solid rgba(217, 180, 91, 0.22);
            padding: 0.85rem 1rem;
            font-size: 0.9rem;
            line-height: 1.45;
        }

        .scoreboard-highlights .player-name {
            display: block;
            font-weight: 600;
            color: rgba(242, 227, 198, 0.95);
            letter-spacing: 0.06em;
        }

        .scoreboard-highlights .player-team {
            display: block;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
            color: rgba(242, 227, 198, 0.65);
        }

        .scoreboard-actions {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            align-items: center;
        }

        .scoreboard-actions button {
            background: linear-gradient(135deg, rgba(217, 180, 91, 0.85), rgba(196, 109, 40, 0.85));
            color: rgba(18, 11, 6, 0.95);
            border: none;
            border-radius: 999px;
            padding: 0.85rem 2.5rem;
            font-size: 1rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-family: "Cinzel", "Times New Roman", serif;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.35);
        }

        .scoreboard-actions button:disabled {
            cursor: not-allowed;
            opacity: 0.75;
            box-shadow: none;
        }

        .scoreboard-actions button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 36px rgba(0, 0, 0, 0.45);
        }

        .scoreboard-note {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(242, 227, 198, 0.65);
            letter-spacing: 0.03em;
            text-align: center;
        }
    </style>
</head>
<body data-game-id="{{ game_id }}">
<header>
    <h1>Ankh-Morpork Scramble</h1>
    <div class="score-line" id="score-line">
        <span>Loading match…</span>
    </div>
    <div class="meta" id="game-meta"></div>
</header>
<main>
    <aside class="panel thoughts" id="team1-thoughts-panel">
        <h2 id="team1-thoughts-title">Team 1 Strategy</h2>
        <ul id="team1-thoughts"></ul>
    </aside>

    <section class="panel pitch-panel">
        <h2>Pitch Overview</h2>
        <div class="pitch-wrapper" id="pitch-container">
            <svg id="pitch-canvas" class="pitch-canvas" role="img" aria-labelledby="pitch-title"></svg>
            <div class="tooltip" id="pitch-tooltip" role="status" aria-live="polite"></div>
        </div>
        <div class="legend" id="legend">
            <span><span class="swatch" style="background: var(--accent-blue);"></span> Team 1</span>
            <span><span class="swatch" style="background: var(--accent-orange);"></span> Team 2</span>
            <span><span class="swatch" style="background: var(--accent-gold);"></span> Ball</span>
        </div>
        <div class="game-log" id="game-log">
            <h3>Recent Events</h3>
            <div class="log-entries" id="game-log-entries">The crowd waits for the opening whistle…</div>
        </div>
        <div class="roster-panel">
            <h2>Players on the Pitch</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Team</th>
                            <th>State</th>
                            <th>Position</th>
                            <th>MA</th>
                            <th>ST</th>
                            <th>AG</th>
                            <th>PA</th>
                            <th>AV</th>
                        </tr>
                    </thead>
                    <tbody id="roster-body"></tbody>
                </table>
            </div>
        </div>
    </section>

    <aside class="panel thoughts" id="team2-thoughts-panel">
        <h2 id="team2-thoughts-title">Team 2 Strategy</h2>
        <ul id="team2-thoughts"></ul>
    </aside>
</main>
<footer>
    Live tactical view for the Ankh-Morpork Scramble. Hover players for details, watch the drive unfold.
</footer>

<div class="scoreboard-overlay" id="scoreboard-overlay" hidden>
    <div class="scoreboard-panel" role="dialog" aria-labelledby="scoreboard-title" aria-modal="true">
        <div class="scoreboard-header">
            <h2 id="scoreboard-title">Final Whistle</h2>
            <p id="scoreboard-subtitle">The pitch falls silent as the dust settles…</p>
        </div>
        <div class="scoreboard-scoreline" aria-live="polite">
            <div>
                <span class="scoreboard-team-name" id="scoreboard-team1-name">Team 1</span>
                <span class="scoreboard-team-score" id="scoreboard-team1-score">0</span>
            </div>
            <div class="scoreboard-score-divider">vs</div>
            <div>
                <span class="scoreboard-team-name" id="scoreboard-team2-name">Team 2</span>
                <span class="scoreboard-team-score" id="scoreboard-team2-score">0</span>
            </div>
        </div>
        <div class="scoreboard-key-stats" id="scoreboard-key-stats" aria-live="polite"></div>
        <div class="scoreboard-highlights">
            <h3>Player Highlights</h3>
            <ul id="scoreboard-highlights"></ul>
        </div>
        <div class="scoreboard-actions">
            <button id="start-new-game-btn">Start New Game</button>
            <p id="scoreboard-note" class="scoreboard-note"></p>
        </div>
    </div>
</div>

<script>
    const gameId = document.body.dataset.gameId;
    const scoreLine = document.getElementById('score-line');
    const meta = document.getElementById('game-meta');
    const pitchSvg = document.getElementById('pitch-canvas');
    const tooltip = document.getElementById('pitch-tooltip');
    const rosterBody = document.getElementById('roster-body');
    const team1Thoughts = document.getElementById('team1-thoughts');
    const team2Thoughts = document.getElementById('team2-thoughts');
    const team1Title = document.getElementById('team1-thoughts-title');
    const team2Title = document.getElementById('team2-thoughts-title');
    const gameLogEntries = document.getElementById('game-log-entries');
    const scoreboardOverlay = document.getElementById('scoreboard-overlay');
    const scoreboardSubtitle = document.getElementById('scoreboard-subtitle');
    const scoreboardTeam1Name = document.getElementById('scoreboard-team1-name');
    const scoreboardTeam1Score = document.getElementById('scoreboard-team1-score');
    const scoreboardTeam2Name = document.getElementById('scoreboard-team2-name');
    const scoreboardTeam2Score = document.getElementById('scoreboard-team2-score');
    const scoreboardKeyStats = document.getElementById('scoreboard-key-stats');
    const scoreboardHighlights = document.getElementById('scoreboard-highlights');
    const startNewGameBtn = document.getElementById('start-new-game-btn');
    const scoreboardNote = document.getElementById('scoreboard-note');

    const PITCH_WIDTH = 26;
    const PITCH_HEIGHT = 15;

    function initPitchGrid() {
        pitchSvg.setAttribute('viewBox', `0 0 ${PITCH_WIDTH} ${PITCH_HEIGHT}`);
        pitchSvg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        pitchSvg.innerHTML = '';

        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.setAttribute('id', 'pitch-title');
        title.textContent = 'Current drive pitch overview';
        pitchSvg.appendChild(title);

        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'endzone');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('y2', '0%');

        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', 'rgba(63, 124, 172, 0.24)');

        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', 'rgba(196, 109, 40, 0.24)');

        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        pitchSvg.appendChild(defs);

        const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        background.setAttribute('x', 0);
        background.setAttribute('y', 0);
        background.setAttribute('width', PITCH_WIDTH);
        background.setAttribute('height', PITCH_HEIGHT);
        background.setAttribute('fill', 'url(#endzone)');
        background.setAttribute('opacity', '0.3');
        pitchSvg.appendChild(background);

        const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        gridGroup.setAttribute('id', 'pitch-grid');
        pitchSvg.appendChild(gridGroup);

        for (let y = 0; y < PITCH_HEIGHT; y += 1) {
            for (let x = 0; x < PITCH_WIDTH; x += 1) {
                const cell = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                cell.setAttribute('x', x);
                cell.setAttribute('y', y);
                cell.setAttribute('width', 1);
                cell.setAttribute('height', 1);
                const isAlt = (x + y) % 2 === 0;
                cell.setAttribute('fill', isAlt ? 'rgba(76, 54, 30, 0.82)' : 'rgba(52, 35, 20, 0.82)');
                cell.setAttribute('stroke', 'rgba(217, 180, 91, 0.22)');
                cell.setAttribute('stroke-width', '0.03');
                gridGroup.appendChild(cell);
            }
        }

        const halfway = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        halfway.setAttribute('x1', PITCH_WIDTH / 2);
        halfway.setAttribute('x2', PITCH_WIDTH / 2);
        halfway.setAttribute('y1', 0);
        halfway.setAttribute('y2', PITCH_HEIGHT);
        halfway.setAttribute('stroke', 'rgba(217, 180, 91, 0.55)');
        halfway.setAttribute('stroke-dasharray', '0.2 0.8');
        halfway.setAttribute('stroke-width', '0.12');
        pitchSvg.appendChild(halfway);

        const tokensGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        tokensGroup.setAttribute('id', 'pitch-tokens');
        pitchSvg.appendChild(tokensGroup);
    }

    function updateScoreboard(state) {
        const team1 = state.team1;
        const team2 = state.team2;
        scoreLine.innerHTML = `
            <span class="score-team score-team--home">${team1.name}</span>
            <span class="score-value">${team1.score}<small> Scratches</small></span>
            <span class="score-divider">VS</span>
            <span class="score-value">${team2.score}<small> Scratches</small></span>
            <span class="score-team score-team--away">${team2.name}</span>
        `;

        const chips = [];
        chips.push(`<span>Phase: ${state.phase}</span>`);

        if (state.turn) {
            chips.push(`<span>Half: ${state.turn.half}</span>`);
            chips.push(`<span>Turn: ${state.turn.team_turn}</span>`);
            chips.push(`<span>Active team: ${state.turn.active_team_id}</span>`);
        } else {
            chips.push('<span>No active turn</span>');
        }

        const ballStatus = (() => {
            const carrier = state.pitch.ball_carrier;
            const ballPos = state.pitch.ball_position;
            if (carrier) {
                return `Carried by ${carrier}`;
            }
            if (ballPos) {
                return `Loose at (${ballPos.x}, ${ballPos.y})`;
            }
            return 'Ball off pitch';
        })();
        chips.push(`<span data-role="ball">${ballStatus}</span>`);

        meta.innerHTML = chips.join('');
    }

    function createPlayerTooltip(player, team, position, isCarrier) {
        const heading = `${player.position.role}`;
        const status = isCarrier ? 'Carrying the ball' : `State: ${player.state}`;
        const stats = `MA ${player.position.ma}  ST ${player.position.st}  AG ${player.position.ag}  PA ${player.position.pa}  AV ${player.position.av}`;
        const location = `Square (${position.x}, ${position.y})`;

        return `
            <span class="name">${heading}</span>
            <span>${team.name}</span>
            <div class="stat-line">${status}</div>
            <div class="stat-line">${location}</div>
            <div class="stat-line">${stats}</div>
        `;
    }

    function positionTooltip(event) {
        const bounds = event.currentTarget.ownerSVGElement.getBoundingClientRect();
        const x = event.clientX - bounds.left;
        const y = event.clientY - bounds.top;
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
    }

    function bindTooltip(node) {
        node.addEventListener('mouseenter', (event) => {
            tooltip.innerHTML = event.currentTarget.dataset.tooltip;
            tooltip.classList.add('visible');
            positionTooltip(event);
        });
        node.addEventListener('mousemove', positionTooltip);
        node.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
        });
    }

    function renderPitch(state) {
        const tokensGroup = document.getElementById('pitch-tokens');
        tokensGroup.innerHTML = '';

        const teamMap = new Map([
            [state.team1.id, { ...state.team1, color: '--accent-blue' }],
            [state.team2.id, { ...state.team2, color: '--accent-orange' }]
        ]);

        const playerEntries = Object.entries(state.pitch.player_positions || {});
        playerEntries.forEach(([playerId, pos]) => {
            const player = state.players[playerId];
            if (!player) return;
            const team = teamMap.get(player.team_id);
            const token = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            token.setAttribute('class', 'player-token');

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', pos.x + 0.5);
            circle.setAttribute('cy', pos.y + 0.5);
            circle.setAttribute('r', 0.45);
            circle.setAttribute('fill', `var(${team.color})`);
            circle.setAttribute('stroke', 'rgba(18, 12, 7, 0.9)');
            circle.setAttribute('stroke-width', '0.08');
            token.appendChild(circle);

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', pos.x + 0.5);
            label.setAttribute('y', pos.y + 0.55);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('font-size', '0.4');
            label.setAttribute('fill', 'rgba(18, 12, 7, 0.95)');
            label.setAttribute('font-weight', '600');
            label.textContent = player.position.role.split(' ').map(word => word[0]).join('').slice(0, 2).toUpperCase();
            token.appendChild(label);

            const isCarrier = state.pitch.ball_carrier === playerId;
            token.dataset.tooltip = createPlayerTooltip(player, team, pos, isCarrier);
            bindTooltip(token);

            if (isCarrier) {
                const aura = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                aura.setAttribute('cx', pos.x + 0.5);
                aura.setAttribute('cy', pos.y + 0.5);
                aura.setAttribute('r', 0.7);
                aura.setAttribute('fill', 'none');
                aura.setAttribute('stroke', 'var(--accent-gold)');
                aura.setAttribute('stroke-width', '0.12');
                aura.setAttribute('stroke-dasharray', '0.3 0.2');
                token.insertBefore(aura, circle);
            }

            tokensGroup.appendChild(token);
        });

        if (state.pitch.ball_position && !state.pitch.ball_carrier) {
            const ball = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            ball.setAttribute('cx', state.pitch.ball_position.x + 0.5);
            ball.setAttribute('cy', state.pitch.ball_position.y + 0.5);
            ball.setAttribute('r', 0.25);
            ball.setAttribute('fill', 'var(--accent-gold)');
            ball.setAttribute('stroke', 'rgba(18, 12, 7, 0.9)');
            ball.setAttribute('stroke-width', '0.08');
            tokensGroup.appendChild(ball);
        }
    }

    function renderThoughts(state) {
        const thoughts = {
            [state.team1.id]: [],
            [state.team2.id]: []
        };

        Object.entries(state.pitch.player_positions || {}).forEach(([playerId, pos]) => {
            const player = state.players[playerId];
            if (!player) return;
            const isCarrier = state.pitch.ball_carrier === playerId;
            const playerState = player.state.replace(/_/g, ' ');
            const snippet = isCarrier
                ? `${player.position.role} is charging ahead with the ball at (${pos.x}, ${pos.y}).`
                : `${player.position.role} holds ${playerState} at (${pos.x}, ${pos.y}).`;
            thoughts[player.team_id].push({
                speaker: player.position.role,
                text: snippet,
                priority: isCarrier ? 0 : 1
            });
        });

        [
            [state.team1, team1Thoughts, team1Title],
            [state.team2, team2Thoughts, team2Title]
        ].forEach(([team, container, title]) => {
            title.textContent = `${team.name} dugout chatter`;
            const teamThoughts = thoughts[team.id]
                .sort((a, b) => a.priority - b.priority)
                .slice(0, 4);

            if (teamThoughts.length === 0) {
                container.innerHTML = '<li>No players on the pitch yet. Set your formation!</li>';
                return;
            }

            container.innerHTML = teamThoughts.map(({ speaker, text }) => `
                <li>
                    <span class="speaker">${speaker}</span>
                    ${text}
                </li>
            `).join('');
        });
    }

    function renderRoster(state) {
        const rows = [];
        const playerEntries = Object.entries(state.pitch.player_positions || {});
        playerEntries.sort(([, aPos], [, bPos]) => (aPos.y - bPos.y) || (aPos.x - bPos.x));

        const teamColors = {
            [state.team1.id]: 'team1',
            [state.team2.id]: 'team2'
        };

        playerEntries.forEach(([playerId, pos]) => {
            const player = state.players[playerId];
            if (!player) return;
            const teamAttr = teamColors[player.team_id] || '';
            const stateLabel = player.state.replace(/_/g, ' ').toLowerCase();
            rows.push(`
                <tr>
                    <td>${player.position.role}</td>
                    <td><span class="team-pill" data-team="${teamAttr}">${player.team_id}</span></td>
                    <td>${stateLabel}</td>
                    <td>(${pos.x}, ${pos.y})</td>
                    <td>${player.position.ma}</td>
                    <td>${player.position.st}</td>
                    <td>${player.position.ag}</td>
                    <td>${player.position.pa}</td>
                    <td>${player.position.av}</td>
                </tr>
            `);
        });

        rosterBody.innerHTML = rows.join('');
    }

    function parseMarkdownToHTML(markdown) {
        let html = markdown;

        // Headers
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        html = html.replace(/^## (.+)$/gm, '<h2>$2</h2>');
        html = html.replace(/^### (.+)$/gm, '<h3>$3</h3>');

        // Horizontal rules
        html = html.replace(/^---$/gm, '<hr>');

        // Bold
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Lists (basic support)
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

        // Line breaks
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    function stopPolling() {
        if (pollIntervalId) {
            clearInterval(pollIntervalId);
            pollIntervalId = null;
        }
        isPolling = false;
    }

    function hideScoreboard() {
        scoreboardVisible = false;
        scoreboardOverlay.classList.remove('visible');
        scoreboardOverlay.setAttribute('hidden', 'true');
        scoreboardHighlights.innerHTML = '';
        scoreboardKeyStats.innerHTML = '';
        scoreboardNote.textContent = '';
        scoreboardStatsCache = null;
        startNewGameBtn.disabled = false;
        startNewGameBtn.textContent = 'Start New Game';
    }

    function formatAttempt(success = 0, attempts = 0) {
        if (!attempts) {
            return `${success}/${attempts}`;
        }
        const rate = Math.round((success / attempts) * 100);
        return `${success}/${attempts} (${rate}%)`;
    }

    function formatTurnoverReason(reason) {
        const labels = {
            failed_dodge: 'Failed dodge',
            failed_rush: 'Failed rush',
            failed_pickup: 'Failed pickup',
            failed_catch: 'Failed catch',
            fumbled_pass: 'Fumbled pass',
            ball_carrier_down: 'Carrier down',
            throw_teammate_failed: 'Thrown teammate mishap',
            unknown: 'Mysterious mishap'
        };
        return labels[reason] || reason.replace(/_/g, ' ');
    }

    function createStatCard(label, team1Value, team2Value, metaText = '') {
        return `
            <div class="scoreboard-stat-card">
                <h4>${label}</h4>
                <div class="scoreboard-stat-values">
                    <span>${team1Value}</span>
                    <span>${team2Value}</span>
                </div>
                ${metaText ? `<div class="scoreboard-stat-meta">${metaText}</div>` : ''}
            </div>
        `;
    }

    function renderKeyStats(teamStats, aggregateStats, state) {
        if (!teamStats) {
            scoreboardKeyStats.innerHTML = '';
            return;
        }

        const team1Stats = teamStats[state.team1.id] || {};
        const team2Stats = teamStats[state.team2.id] || {};

        let turnoverMeta = '';
        const turnoverEntries = aggregateStats && aggregateStats.turnovers_by_reason
            ? Object.entries(aggregateStats.turnovers_by_reason)
            : [];
        if (turnoverEntries.length) {
            turnoverEntries.sort((a, b) => b[1] - a[1]);
            const [reason, count] = turnoverEntries[0];
            turnoverMeta = `Most common: ${formatTurnoverReason(reason)} (${count})`;
        }

        const cards = [
            createStatCard('Touchdowns', team1Stats.touchdowns ?? 0, team2Stats.touchdowns ?? 0),
            createStatCard('Casualties Caused', team1Stats.casualties_caused ?? 0, team2Stats.casualties_caused ?? 0),
            createStatCard('Passes Completed', formatAttempt(team1Stats.passes_completed ?? 0, team1Stats.passes_attempted ?? 0), formatAttempt(team2Stats.passes_completed ?? 0, team2Stats.passes_attempted ?? 0)),
            createStatCard('Ball Pickups', formatAttempt(team1Stats.pickups_succeeded ?? 0, team1Stats.pickups_attempted ?? 0), formatAttempt(team2Stats.pickups_succeeded ?? 0, team2Stats.pickups_attempted ?? 0)),
            createStatCard('Turnovers', team1Stats.turnovers ?? 0, team2Stats.turnovers ?? 0, turnoverMeta),
            createStatCard('Blocks Thrown', team1Stats.blocks_thrown ?? 0, team2Stats.blocks_thrown ?? 0)
        ];

        scoreboardKeyStats.innerHTML = cards.join('');
    }

    function renderPlayerHighlights(stats, state) {
        const players = Object.values(stats.player_stats || {});
        if (!players.length) {
            scoreboardHighlights.innerHTML = '<li>No player statistics recorded yet.</li>';
            return;
        }

        const teamLookup = {
            [state.team1.id]: state.team1.name,
            [state.team2.id]: state.team2.name
        };

        const decorated = players.map((player) => {
            const impact = (player.touchdowns * 100)
                + (player.casualties_caused * 80)
                + (player.passes_completed * 25)
                + player.moves;
            return { ...player, impact };
        }).sort((a, b) => b.impact - a.impact);

        const topPerformers = decorated.filter((player) => player.impact > 0).slice(0, 4);

        if (!topPerformers.length) {
            scoreboardHighlights.innerHTML = '<li>The match ends without a standout hero. Perhaps next time!</li>';
            return;
        }

        const lines = topPerformers.map((player) => {
            const segments = [];
            if (player.touchdowns) {
                segments.push(`${player.touchdowns} touchdown${player.touchdowns === 1 ? '' : 's'}`);
            }
            if (player.casualties_caused) {
                segments.push(`${player.casualties_caused} casualty${player.casualties_caused === 1 ? '' : 'ies'}`);
            }
            if (player.passes_completed) {
                segments.push(`${player.passes_completed} accurate pass${player.passes_completed === 1 ? '' : 'es'}`);
            }
            if (!segments.length) {
                segments.push(`${player.moves} squares travelled`);
            }

            return `
                <li>
                    <span class="player-name">${player.player_name}</span>
                    <span class="player-team">${teamLookup[player.team_id] || 'Neutral stand-in'}</span>
                    <span>${segments.join(' · ')}</span>
                </li>
            `;
        });

        scoreboardHighlights.innerHTML = lines.join('');
    }

    function describeOutcome(state) {
        const diff = state.team1.score - state.team2.score;
        if (diff === 0) {
            return `A hard-fought draw finishes ${state.team1.score}-${state.team2.score}.`;
        }

        const winner = diff > 0 ? state.team1 : state.team2;
        const loser = diff > 0 ? state.team2 : state.team1;
        const margin = Math.abs(diff);
        const marginText = margin === 1 ? 'by a single scratch' : `by ${margin} scratches`;
        return `${winner.name} prevail ${marginText} over ${loser.name}.`;
    }

    async function fetchScoreboardStatistics() {
        if (scoreboardStatsCache) {
            return scoreboardStatsCache;
        }

        const response = await fetch(`/game/${gameId}/statistics`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        scoreboardStatsCache = data;
        return data;
    }

    async function showScoreboard(state) {
        if (scoreboardVisible) {
            return;
        }

        scoreboardVisible = true;
        stopPolling();

        scoreboardTeam1Name.textContent = state.team1.name;
        scoreboardTeam2Name.textContent = state.team2.name;
        scoreboardTeam1Score.textContent = state.team1.score;
        scoreboardTeam2Score.textContent = state.team2.score;
        scoreboardSubtitle.textContent = describeOutcome(state);

        scoreboardOverlay.removeAttribute('hidden');
        requestAnimationFrame(() => scoreboardOverlay.classList.add('visible'));

        startNewGameBtn.disabled = false;
        startNewGameBtn.textContent = 'Start New Game';
        scoreboardNote.textContent = 'Review the post-match report, then launch a new kickoff when you are ready.';

        try {
            const stats = await fetchScoreboardStatistics();
            renderKeyStats(stats.team_stats, stats, state);
            renderPlayerHighlights(stats, state);
        } catch (error) {
            console.error('Failed to load statistics:', error);
            scoreboardKeyStats.innerHTML = '';
            scoreboardHighlights.innerHTML = '<li>Unable to load detailed statistics.</li>';
            scoreboardNote.textContent = `Statistics unavailable: ${error.message}`;
        }
    }

    startNewGameBtn.addEventListener('click', async () => {
        if (startNewGameBtn.disabled) {
            return;
        }

        startNewGameBtn.disabled = true;
        startNewGameBtn.textContent = 'Preparing…';
        scoreboardNote.textContent = 'Resetting the pitch and rousing the teams…';

        try {
            const response = await fetch(`/game/${gameId}/rematch`, { method: 'POST' });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const nextState = await response.json();

            hideScoreboard();

            updateScoreboard(nextState);
            renderPitch(nextState);
            renderThoughts(nextState);
            renderRoster(nextState);
            fetchGameLog();

            if (!isPolling) {
                startPolling();
            }
        } catch (error) {
            console.error('Failed to start new game:', error);
            startNewGameBtn.disabled = false;
            startNewGameBtn.textContent = 'Start New Game';
            scoreboardNote.textContent = `Could not start a new game: ${error.message}`;
        }
    });

    async function fetchGameLog() {
        try {
            const response = await fetch(`/game/${gameId}/log?format=markdown`);
            if (!response.ok) {
                throw new Error(`Failed to load game log (${response.status})`);
            }
            const markdown = await response.text();

            // Parse and render markdown
            const html = parseMarkdownToHTML(markdown);
            gameLogEntries.innerHTML = html;

            // Auto-scroll to bottom
            gameLogEntries.scrollTop = gameLogEntries.scrollHeight;
        } catch (error) {
            console.error('Failed to fetch game log:', error);
            // Keep existing content on error
        }
    }

    // Configuration (poll_interval is configurable via template variable)
    const POLL_INTERVAL = {{ poll_interval }};
    const MAX_CONSECUTIVE_FAILURES = 5;
    const RETRY_DELAYS = [1000, 2000, 4000, 8000, 16000];

    // State tracking
    let consecutiveFailures = 0;
    let pollIntervalId = null;
    let isPolling = false;
    let scoreboardVisible = false;
    let scoreboardStatsCache = null;

    async function fetchState() {
        try {
            const response = await fetch(`/game/${gameId}`);
            if (!response.ok) {
                throw new Error(`Failed to load state (${response.status})`);
            }
            const data = await response.json();

            // Reset failure count on success
            consecutiveFailures = 0;

            updateScoreboard(data);
            renderPitch(data);
            renderThoughts(data);
            renderRoster(data);

            if (data.phase === 'finished') {
                await showScoreboard(data);
            } else if (scoreboardVisible) {
                hideScoreboard();
            }

            // Fetch and render game log
            fetchGameLog();

            // Clear any error messages
            if (meta.querySelector('.connection-error')) {
                const errorChip = meta.querySelector('.connection-error');
                errorChip.remove();
            }
        } catch (error) {
            consecutiveFailures++;
            console.error(`Failed to fetch state (attempt ${consecutiveFailures}):`, error);

            if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
                // Stop polling after too many failures
                stopPolling();

                scoreLine.innerHTML = `<span style="color: #e07856;">Connection lost after ${MAX_CONSECUTIVE_FAILURES} attempts</span>`;
                meta.innerHTML = `
                    <span class="connection-error" style="background: rgba(224, 120, 86, 0.3); border-color: rgba(224, 120, 86, 0.5); color: #e07856;">
                        ⚠ Polling stopped. <a href="javascript:location.reload()" style="color: inherit; text-decoration: underline;">Reload page</a> to retry.
                    </span>
                `;
            } else {
                // Show temporary error with retry countdown
                const retryDelay = RETRY_DELAYS[Math.min(consecutiveFailures - 1, RETRY_DELAYS.length - 1)];
                const retrySeconds = Math.ceil(retryDelay / 1000);

                scoreLine.innerHTML = `<span style="color: #e07856;">Unable to load match: ${error.message}</span>`;

                // Add or update connection warning chip
                let errorChip = meta.querySelector('.connection-error');
                if (!errorChip) {
                    errorChip = document.createElement('span');
                    errorChip.className = 'connection-error';
                    errorChip.style.cssText = 'background: rgba(224, 120, 86, 0.25); border-color: rgba(224, 120, 86, 0.4); color: rgba(224, 120, 86, 0.95);';
                    meta.appendChild(errorChip);
                }
                errorChip.textContent = `⚠ Connection issue (${consecutiveFailures}/${MAX_CONSECUTIVE_FAILURES}) - retrying in ${retrySeconds}s...`;
            }
        }
    }

    function startPolling() {
        if (isPolling) {
            return;
        }
        isPolling = true;

        // Initial fetch
        fetchState();

        // Set up polling interval
        pollIntervalId = setInterval(fetchState, POLL_INTERVAL);
    }

    // Initialize
    initPitchGrid();
    fetchGameLog();  // Initial log fetch
    startPolling();
</script>
</body>
</html>
