version: "3.9"

services:
  game-server:
    build: .
    image: ankh-morpork-scramble
    ports:
      - "8000:8000"
    environment:
      - DEMO_MODE=false
      - INTERACTIVE_GAME_ID=${INTERACTIVE_GAME_ID:-interactive-game}
      - openrouter_api_key=${openrouter_api_key}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/game/${INTERACTIVE_GAME_ID:-interactive-game}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  agent-team1:
    build: .
    image: ankh-morpork-scramble
    command: ["uv", "run", "python", "-m", "app.agents.run_agent"]
    environment:
      - TEAM_ID=team1
      - TEAM_NAME=City Watch Constables
      - GAME_ID=${INTERACTIVE_GAME_ID:-interactive-game}
      - MCP_SERVER_URL=http://game-server:8000/mcp
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-google/gemini-2.5-flash}
      - openrouter_api_key=${openrouter_api_key}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - OPENROUTER_REFERER=${OPENROUTER_REFERER:-https://localhost}
      - OPENROUTER_APP_TITLE=${OPENROUTER_APP_TITLE:-Ankh-Morpork Scramble Agents}
      - CLINE_DIR=/tmp/cline-team1
      - AGENT_LOG_LEVEL=${AGENT_LOG_LEVEL:-INFO}
    depends_on:
      game-server:
        condition: service_healthy

  agent-team2:
    build: .
    image: ankh-morpork-scramble
    command: ["uv", "run", "python", "-m", "app.agents.run_agent"]
    environment:
      - TEAM_ID=team2
      - TEAM_NAME=Unseen University Adepts
      - GAME_ID=${INTERACTIVE_GAME_ID:-interactive-game}
      - MCP_SERVER_URL=http://game-server:8000/mcp
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-google/gemini-2.5-flash}
      - openrouter_api_key=${openrouter_api_key}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - OPENROUTER_REFERER=${OPENROUTER_REFERER:-https://localhost}
      - OPENROUTER_APP_TITLE=${OPENROUTER_APP_TITLE:-Ankh-Morpork Scramble Agents}
      - CLINE_DIR=/tmp/cline-team2
      - AGENT_LOG_LEVEL=${AGENT_LOG_LEVEL:-INFO}
    depends_on:
      game-server:
        condition: service_healthy
